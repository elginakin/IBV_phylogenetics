---
title: "Maryland IBV Lineage Phylogenetics Comparison to 2022"
description: "GISAID Collection of IBV strains from B/Victoria and B/Yamagata" 
output: html_notebook
---

# IBV Lineage Comparison 
## Data collection

Sequence were aquired from GISAID in August of 2022 with the following filters: 
  - Segments: HA, NS
  - Dates: All until 2022
  - Complete Sequences only
  
## Sequence alignment and tree building

* Sequences were aligned using ClustalO in Geneious Prime. Phylogenetic trees were constructed using RAxML. 
* Export phylogenetic trees in .nexus format.
* https://guangchuangyu.github.io/ggtree-book/chapter-ggtree.html
* https://yulab-smu.top/treedata-book/chapter13.html
* https://yulab-smu.top/treedata-book/faq.html#faq-local-file
* https://yulab-smu.top/treedata-book/chapter12.html
* https://www.biostars.org/p/312389/
* https://groups.google.com/g/bioc-ggtree/c/Ciy4Fh_7hl4
* https://bioconductor.statistik.tu-dortmund.de/packages/3.6/bioc/vignettes/ggtree/inst/doc/treeAnnotation.html
* https://bioconnector.github.io/workshops/r-ggtree.html#labeling_clades

## Plot using ggtree

```{r, install and import packages }
# Remove '#' character and run code tyo install
#ggtree Test 
#install 

if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

BiocManager::install("YuLab-SMU/treedataverse") #includes ggtree along with other essential packages
# browseVignettes("ggtree") #essnetial guide for tree browsing

library(readr) #importing data 
library(knitr) # knitting .rmd file
library(treedataverse) 
library(ggtree)
library(ggimage)
library(tidytree)
library(ggrepel) 

```

# Building the HA Tree

**Be sure to ROOT all trees in Geneius before importing here** 

B/Victoria vs B/Yamagata HA Tree B/Phuket/2013

Still missing B/Yamagata Sequences
  - R0337 - aquired from Amanda on September 15th - sequenced with some of David Sullivan's strains.  
  - R0225 - provided by Hsuan. 

```{r IBV HA RAXML tree with 4/4 Study Strains with clade labels}

library(readr)
library(knitr)
library(treedataverse)
library(ggtree)
library(ggimage)
library(tidytree)
library(ggrepel)

file_HA_RAXML_newick <- "./tree_builds/B_Vic_B_Yam_HA_Maryland_epiflu_isolates_gisaid_RAXML_ALL.newick" #import built tree 
HA_NJ_RAXML <- read.newick(file_HA_RAXML_newick, node.label = "label") #import newick tree of RAXML HA build
print(HA_NJ_RAXML)

#visualize ggtree object
pHA_lim <- ggtree(HA_NJ_RAXML) + 
  geom_treescale(x=0.02) +
  #Yamagata
  geom_cladelab(node=259,
                label="Yamagata",
                barcolour='red',
                offset = -0.08,
                offset.text = 0.003,
                barsize = 1, 
                align=TRUE, 
                angle=270, 
                hjust='center',
                fontsize = 6) +
  #Victoria  
  geom_cladelab(node=356, 
                label="Victoria", 
                barcolour='blue', 
                barsize = 1,
                offset = 0.028,
                offset.text = 0.003,
                align=TRUE, 
                angle=270, 
                hjust='center', 
                fontsize = 6) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0122/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset=0.001, size = 1.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0001/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset=0.001, size = 1.5 ) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0250/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset= - 0.11, size = 1.5 ) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0337/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset= - 0.11, size = 1.5 ) +
  theme_tree() 

  #geom_text(aes(label=node), size = 1.6 ) #labels branch node ID for labeling purposes...bc Im lazy

pHA_lim #plot tree

#ggsave("B_Maryland_HA_tree_FINAL.jpeg", width = 7, height = 7) #save plot to relative dir

# B/Yam - node 252
# B/Vic - node 353
```

```{r IBV HA RAXML tree with 4/4 Study Strains - with metadata annotations}

file_HA_RAXML_newick <- "./tree_builds/B_Vic_B_Yam_HA_Maryland_epiflu_isolates_gisaid_RAXML_ALL.newick" #import built tree 

HA_meta <- tibble(read_csv('All_HA_vicyam_meta.csv'))#import meta data containing lineage information 

HA_NJ_RAXML <- read.newick(file_HA_RAXML_newick, node.label = "label")  #import newick tree of RAXML HA build
print(HA_NJ_RAXML)

HA_RAXML <-  ggtree(HA_NJ_RAXML) #run tree without annotations 
HA_RAXML

##adding meta data 
HA_node <- HA_RAXML %>% as.treedata %>% as_tibble() #label nodes as numbers
HA_node <- as.phylo(HA_node) #convert to phylo object 
#x <- tibble(label = as.phylo(pHA_RAXML)$tip.label, trait = HA_meta) #import meta data 
HA_node_join <- full_join(HA_node, HA_meta, by = "label") #merge tree and metadata 
HA_node_join <- as_tibble(HA_node_join) #convert to tibble

HA_RAXML + geom_cladelab(data = HA_node_join, 
                          mapping = aes(node = node, label = lineage, color = lineage))

#Additional Annotations with tips and node lables
HA_RAXML_meta <- ggtree(HA_NJ_RAXML, aes(color=HA_node_join$lineage)) + 
  scale_color_manual(values=c("blue", "red"))

#Add clade lables in illustrator, labeling by node number is slow.

HA_RAXML_meta + 
  #Yamagata
  #geom_cladelab(node=266,
  #              label="Yamagata",
  #              barcolour='red',
  #              offset = -0.06,
  #              offset.text = 0.007,
  #              barsize = 0.5, 
  #              align=TRUE, 
  #              angle=270, 
  #              hjust='center',
  #              fontsize = 6) +
  #Victoria  
  #geom_cladelab(node=274, 
  #              label="Victoria", 
  #              barcolour='blue', 
  #              barsize = 0.5,
  #              offset = 0.04,
  #              offset.text = 0.007,
  #              align=TRUE, 
  #             angle=270, 
  #              hjust='center', 
  #              fontsize = 6) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0122/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset=0.001, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0001/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset=0.001, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0250/2018",label,fixed=TRUE)==TRUE)), align = TRUE, offset= - 0.11, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0337/2017",label,fixed=TRUE)==TRUE)), align = TRUE, offset= - 0.11, size = 2.5) + 
  theme_tree() +
  theme(legend.position = 'none') +
  scale_y_continuous(limits=c(-8,260)) +
  scale_x_continuous(limits=c(0,0.25)) +
  geom_treescale(x=0.01, y = -8, fontsize = 3, offset.label = 1) + ggtitle("B/Victoria and B/Yamagata HA RAXML Tree")

  #geom_text(aes(label=node), size = 1.6 ) #labels branch node ID for labeling purposes...bc Im lazy

ggsave("B_Maryland_HA_tree_FINAL.jpeg", width = 7, height = 5) #save plot to relative dir

```

# Building NS Tree

B/Victoria vs B/Yamagata NS1 Tree Rooted to B/Phuket/2013

* RAXML tree chosen for cluster Clarity
* Clade labeling takes so so so long. by node...figure out a better way to do this you bum.

```{r IBV NS RAXML with 4/4 Study Strains with clade lables}

file_NSnewick <- "./tree_builds/B_Vic_B_Yam_NS_Maryland_epiflu_isolates_gisaid_RAXML_ALL.newick"

#Importing newick file
NSnewick <- read.newick(file_NSnewick, node.label = "label") #import newick tree
NS_meta <- tibble(read_csv('All_NS_vicyam_meta.csv')) #import meta data containing lineage information 
NS_RAXML <-  ggtree(NSnewick) #generate tree 
NS_RAXML #show reww without annotations

##adding meta data 
NS_node <- NS_RAXML %>% as.treedata %>% as_tibble() #label nodes as numbers
NS_node <- as.phylo(NS_node) #convert to phylo object 
#x <- tibble(label = as.phylo(pHA_RAXML)$tip.label, trait = HA_meta) #import meta data 
NS_node_join <- full_join(NS_node, NS_meta, by = "label") #merge tree and metadata 
NS_node_join <- as_tibble(NS_node_join) #convert to tibble

NS_RAXML + geom_cladelab(data = NS_node_join, mapping = aes(node = node, label = lineage, color = lineage)) #plot tree with just tip colors

#Additional Annotations with tips and node lables
NS_RAXML_meta <- ggtree(NSnewick, aes(color=NS_node_join$lineage)) + 
  scale_color_manual(values=c("blue", "red"))

pNS_RAXML_meta <- NS_RAXML_meta + 
  #geom_treescale() +
  #Yamagata
  #geom_cladelab(node=200,
  #              label="Yamagata",
  #              barcolour='red',
  #              offset = 0,
  #              offset.text = 0.003,
  #              barsize = 1, 
  #              align=TRUE, 
  #              angle=270, 
  #              hjust='center',
  #              fontsize = 6) +
  #Victoria 
  #geom_cladelab(node=314, 
  #             label="Victoria", 
  #              barcolour='blue', 
  #              barsize = 1,
  #              offset = 0.01495,
  #              offset.text = 0.003,
  #              align=TRUE, 
  #              angle=270, 
  #              hjust='center', 
  #              fontsize = 6) +
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0122/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset= -0.01, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0001/2016",label,fixed=TRUE)==TRUE)), align = TRUE, offset= -0.01, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0250/2018",label,fixed=TRUE)==TRUE)), align = TRUE, offset= -0.01, size = 2.5) + 
  geom_tiplab(aes(subset=(grepl("B/Baltimore/R0337/2017",label,fixed=TRUE)==TRUE)), align = TRUE, offset= -0.01, size = 2.5) +
  scale_x_continuous(limits = c(0, 0.15)) + 
  scale_y_continuous(limits = c(-8,260)) +
  theme_tree() + 
  geom_treescale(x=0.01, y = -8, fontsize = 3, offset.label = 1) +
  theme(legend.position = 'none') + ggtitle("B/Victoria and B/Yamagata NS RAXML Tree")

pNS_RAXML_meta

#geom_text(aes(label=node), size = 1.5 ) #labels branch node ID for labeling purposes...bc Im lazy
ggsave("B_Maryland_NS_tree.jpeg", plot = pNS_RAXML_meta, width = 7, height = 5) #save plot to relative dir

```











# Merging NextClade HA Data with Metadata files

* Lineages were determined by NextClade according to HA for both B/Victoria and B/Yamagata Lineages. 
* Lineage metadata forall samples in HA and NA trees will be concatenated and merged. 


```{r import and merge nextclade tables}

#read om files
file_HA_nc_meta <- "./IBV_Compare_Nextclade/B_Maryland_Victoria_nextclade/B_Maryland_Victoria_nextclade.tsv" #read file from path
file_NS_nc_meta <- "./IBV_Compare_Nextclade/B_Maryland_Victoria_nextclade/B_Maryland_Yamagata_nextclade.tsv" #read file from path

#import data 
HA_nc_meta <- read_tsv(file_HA_nc_meta, col_select = c(seqName, clade))# read vic nexclade only seqName and clade
HA_nc_meta <- read_csv(file_NS_nc_meta, col_select = c(seqName, clade))# read yam nextclade only seqName and clade





```

